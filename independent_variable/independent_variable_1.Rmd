---
title: "Select independent variable"
output: html_document
date: "2025-04-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Đọc dữ liệu đã làm sạch

```{r}

library(knitr)
library(broom)
library(knitr)
library(dplyr)
library(ggcorrplot)     # Vẽ ma trận tương quan
library(ggplot2)
library(car)            # Tính VIF
library(corrplot)       # Vẽ biểu đồ tương quan
data_cleaned <- read.csv("../data_set/data_cleaned.csv")
```

# chọn biến dựa trên cơ sở lý thuyết trước đó (đọc và nghiên cứu file csv hoặc tìm hiểu các nghiên cứu tương tự) đi đến chọn biến và đem đi kiểm định bằng phương pháp sử dụng ma trận tương quan để kiểm tra

```{r}
# Lựa chọn các biến có tương quan tốt và không đa cộng tuyến cao
selected_data <- data_cleaned %>%
  select(LIFE.EXPECTANCY, INCOME.COMPOSITION.OF.RESOURCES, ADULT.MORTALITY, BMI,PERCENTAGE.EXPENDITURE,TOTAL.EXPENDITURE, SCHOOLING)
```

```{r}
#Tính và vẽ ma trận tương quan
cor_matrix <- cor(selected_data, use = "complete.obs")

ggcorrplot(
  cor_matrix,
  hc.order = FALSE,  # Tắt sắp xếp phân cụm để giữ nguyên thứ tự biến
  type = "full",     # Hiển thị toàn bộ ma trận (không chỉ nửa dưới)
  lab = TRUE,
  lab_size = 3,
  tl.cex = 8,        # Tăng kích thước chữ tên biến
  tl.srt = 45,       # Xoay tên biến 45 độ
  title = "Ma trận tương quan giữa các biến",
) +
  theme(
    axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 8)
  )
```
từ ma trận tương quan
-Chọn biến có tương quan mạnh với biến phụ thuộc (Life.expectancy).
-Loại bỏ biến độc lập quá tương quan với nhau (đa cộng tuyến).
-Biến phụ thuộc: Chọn biến có |r| > 0.3–0.5 với Life.expectancy.
-Biến độc lập: Nếu 2 biến có |r| > 0.7–0.8 với nhau → Chỉ giữ 1.
# loại biến TOTAL.EXPENDITURE vì ít tương quan đến Life.expectancy
#biến SCHOOLING và biến INCOME.COMPOSITION.OF.RESOURCES không xét chung model
# -------------------------------------------------------------------

# \>\>\>\>\> XÂY DỰNG CÁC MÔ HÌNH \<\<\<\<\<

> > final đã rồi t ghi document sau

# MÔ HÌNH 1: Nói về kinh Tế - Y Tế

```{r}
model1 <- lm(LIFE.EXPECTANCY ~ INCOME.COMPOSITION.OF.RESOURCES + ADULT.MORTALITY + PERCENTAGE.EXPENDITURE, data = selected_data)
```

> > Target: Dự đoán tuổi thọ dựa trên các yếu tố  y tế, đầu tư của chính phủ vào y tế
- INCOME.COMPOSITION.OF.RESOURCES cho thấy được thu nhập và chất lượng cuộc sống từ đó phản ánh khả năng tiếp cận dịch vụ y tế, giáo dục, dinh dưỡng.
- ADULT.MORTALITYN, PERCENTAGE.EXPENDITURE cho thấy được mức tử vong của người trưởng thành và sựu đầu tư vào y tế cảu chính phủ 
--> Từ đó, đưa ra được insight về vấn đề y tế --> cần cải thiện vấn đề về y tế để giảm thiểu mức độ tử vong

# MÔ HÌNH 2: Sự tương tác giữa giáo dục và thu nhập

```{r}

model2 <- lm(LIFE.EXPECTANCY ~ INCOME.COMPOSITION.OF.RESOURCES * SCHOOLING + ADULT.MORTALITY,
  data = selected_data)

```

> > Income.composition.of.resources \* Schooling: ý nghĩa giáo dục cao -\> có thể tác động đến khoảng thu nhập -\> khoảng thu nhập cao -\> chất lượng cuộc sống tốt -\> ảnh hưởng đến tuổi thọ
- Kết hợp giữa giáo dục và thu nhập -> Dựa vào giáo dục mà đánh giá lên được cùng 1 mức thu nhập nhưng tuổi thọ lại khác nhau ở mỗi quốc gia 
- Phát hiện ra được giáo dục giúp tăng được thu nhập -> có thể tăng được sức khỏe

# MÔ HÌNH 3: Nói về y tế và dinh dưỡng 

```{r}
# MÔ HÌNH 3
model3 <- lm(LIFE.EXPECTANCY ~ ADULT.MORTALITY + BMI + SCHOOLING, data = selected_data)
```
>>> Nói sâu về vấn đề sức khỏe, giáo dục ảnh hưởng đến nhận thức về sức khỏe, 
- Tập trung vào chủ yếu là yếu tố sức khỏe trực tiếp:
+ BMI -> Nói lên được tình trạng dinh dưỡng (Từ lối sống lành mạnh hay không)
+ SHOOLING: tác động đến nhận thức vào hành vi sức khỏe 
+ ADULT.MORTALITY: Tỉ lệ tử vong của người lớn -> phản ánh lên được chất lượng hệ thống y tế

# MÔ HÌNH 4: Khác biệt về giáo dục, chỉ số BMI ở các quốc gia

```{r}
model4 <- lm(LIFE.EXPECTANCY ~ 
              SCHOOLING * COUNTRY + 
              BMI * COUNTRY + 
              ADULT.MORTALITY,
            data = data_cleaned)
```

>>>  Phát hiện sự khác biệt của các quốc gia về hiệu quả cảu giáo dục lên tuổi thọ, tác động dinh dưỡng lên sức khỏe 
-----------------------------------------------------------------------

# KẾT QUẢ
```{r}
# Hàm in kết quả
print_results <- function(model, model_name = "Mô hình") {
  # Hệ số
  cat("\n", paste0("=== ", model_name, " ==="), "\n")
  
  coef_table <- tidy(model) %>%
  mutate(
    significance = ifelse(p.value < 0.001, "***", 
                          ifelse(p.value < 0.01, "**", 
                                 ifelse(p.value < 0.05, "*", "NS"))) # Thêm "NS" cho không có ý nghĩa thống kê
  )

  
  # Đổi tên cột có thể ngắt dòng (HTML cần escape = FALSE)
  colnames(coef_table) <- c(
    "Biến<br>(term)", 
    "Ước lượng<br>(estimate)", 
    "Sai số<br>(std.error)", 
    "Giá trị t<br>(statistic)", 
    "Giá trị p<br>(p.value)", 
    "Ý nghĩa<br>thống kê"
  )
    # In bảng đẹp
  print(kable(coef_table, digits = 3, caption = "Hệ số hồi quy"))
  
  # Model summary
  model_summary <- glance(model) %>%
  select(r.squared, adj.r.squared, sigma, statistic, p.value, nobs)
  colnames(model_summary) <- c("R²", "R² hiệu chỉnh", "Sai số", "F", "p-value", "N")
  print(kable(model_summary, digits = 3, caption = "Chỉ số tổng quan"))
  
  # VIF (không áp dụng cho model có interaction nếu chưa chuẩn hóa) (MODEL 2)
  if (!any(grepl(":", names(coef(model))))) { # Check interaction terms
    vif_values <- car::vif(model)
    print(kable(data.frame(VIF = vif_values), digits = 1, caption = "Kiểm tra VIF"))
  }
}

```

```{r}

print_results(model1)

```

```{r}
print_results(model2)
```

>>> KQua model 3

```{r}
print_results(model3)
```
```{r}
print_results(model4)
coef_df <- tidy(model4) %>%
  filter(grepl("SCHOOLING:", term)) %>%
  arrange(desc(estimate))

head(coef_df, 10) 
```


